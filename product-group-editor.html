<!DOCTYPE html>
<html lang="en" ng-app="theApp">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Product Group Editor | BTBADMIN</title>
        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <!-- JWL CSS stylesheet -->
        <link href="css/jwl.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="js/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/bootstrap.min.js"></script>
        <!-- AngularJS -->
        <script src="js/angular.min.js"></script>
        <!-- JWL JavaScript -->
        <script src="js/jwl.js"></script>
        <!-- This page's NG app/controller -->
        <script>
            angular.module("theApp",[]).controller("theController",function($window,$http){
                var self = this;
                self.columns = [];
                self.search = [];
                self.records = [];
                self.options = [];
                self.getColumns = function(){
                    $http.get("json/group-get-columns-test.json").then(function(response){
                        self.columns = response.data;
                    },function(response){});
                };
                self.getRecords = function(){
                    if (self.search.field&&self.search.value) $http.get("json/group-get-records-test.json",{params:{field:self.search.field,isStrict:self.search.isStrict,value:self.search.value}}).then(function(response){
                        self.records = response.data;
                    },function(response){});
                };
                self.refineSearch = function(col,cell){
                    self.search.field = col;
                    self.search.isStrict = "true";
                    self.search.value = cell;
                    self.getRecords();
                };
                self.batchEdit = function(col,cell){
                    var rows = Object.keys(self.records);
                    for (var i in rows) {
                        self.records[rows[i]][col] = cell;
                    };
                };
                self.save = function(){
                    var postParams = {};
                    for (var i = 0; i<self.results.length; i++) {
                        var k = self.results[i]["PR_ProductID"];
                        for (var j in self.results[i]) {
                            if (self.results[i][j]!=self.originalResults[i][j]) postParams[k+"__"+j] = self.results[i][j];
                       };
                    };
                    $http.post("php/update.php",{params:postParams}).then(function(response){
                        window.alert("!");
                    },function(response){})
                };
                self.getColumns();
            });
        </script>
    </head>
    <body ng-controller="theController as main">
        <ng-include src="'incl/navbar.html'"></ng-include>
        <ng-include src="'incl/alerts.html'"></ng-include>
        <div class="container jwl-normal-container">
            <h1>Product Group Editor</h1>
            <h2>Search</h2>
            <p><form role="form" class="form-inline">
                <div class="form-group">
                    <select class="form-control" ng-model="main.search.field">
                        <option ng-repeat="(columnName,columnMeta) in main.columns" value="{{columnName}}">{{columnName}}</option>
                    </select>                    
                </div>
                <div class="form-group">
                    <select class="form-control" ng-model="main.search.isStrict">
                        <option value="true">equals</option>
                        <option value="">contains</option>
                    </select>
                </div>
                <div class="form-group"><input class="form-control" type="text" ng-model="main.search.value"></div>
                <button type="submit" ng-click="main.getRecords()" class="btn btn-primary"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search</button>
            </form></p>
            <h2>Available Columns</h2>
            <p><button type="button" ng-repeat="(columnName,columnMeta) in main.columns" ng-click="columnMeta.isVisible = !columnMeta.isVisible" ng-hide="columnMeta.isVisible" class="btn btn-xs btn-success">{{columnName}}</button></p>
            <h2>Current Recordset</h2>
            <table class="table table-bordered">
                <thead><tr><th ng-repeat="(columnName,columnMeta) in main.columns" ng-show="columnMeta.isVisible"><button type="button" ng-click="columnMeta.isVisible = !columnMeta.isVisible" class="btn btn-xs btn-success">{{columnName}}</button><!--<button type="button" ng-click="main.options.sortOrder = columnName"  class="btn btn-xs btn-success"><span class="glyphicon glyphicon-sort-by-attributes-alt" aria-hidden="true"></span></button><button type="button" ng-click="main.options.sortOrder = '-'+columnName" class="btn btn-xs btn-success"><span class="glyphicon glyphicon-sort-by-attributes" aria-hidden="true"></span></button>--></th></tr></thead>
                <tr ng-repeat="row in main.records | orderBy: main.options.sortOrder">
                    <td ng-repeat="(col,cell) in row" ng-show="main.columns[col].isVisible">
                        <div ng-hide="main.columns[col].readonly" ng-click="editing = true"><a>{{cell}}</a>&nbsp;</div>
                        <div ng-hide="!main.columns[col].readonly">{{cell}}</div>
                        <div style="position:absolute" ng-show="editing"><form role="form" class="form-inline">
                                <div class="form-group"><input class="form-control" type="text" ng-model="cell"></div>
                                <button type="submit" class="btn btn-primary" ng-click="editing = false"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></button>
                                <button type="button" ng-click="editing = false; main.batchEdit(col,cell)" class="btn btn-primary"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></button>
                                <button type="button" ng-click="editing = false; main.refineSearch(col,cell)" class="btn btn-primary"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>     
                        </form></div>
                    </td>
                </tr>
            </table>
        </div>
        <ng-include src="'incl/footer.html'"></ng-include>
    </body>
</html>