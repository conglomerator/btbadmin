<!DOCTYPE html>
<html lang="en" ng-app="theApp">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Product Group Editor | BTBADMIN</title>
        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <!-- JWL CSS stylesheet -->
        <link href="css/jwl.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="js/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="js/bootstrap.min.js"></script>
        <!-- AngularJS -->
        <script src="js/angular.min.js"></script>
        <!-- JWL JavaScript -->
        <script src="js/jwl.js"></script>
        <!-- This page's NG app/controller -->
        <script>
            angular.module("theApp",[]).controller("theController",function($http){
                var self = this;
                self.columns = [];
                self.originalResults = [];
                self.results = [];
                self.getColumns = function(){
                    $http.get("json/group-get-columns-test.json").then(function(response){
                        self.columns = response.data;
                    },function(response){});
                };
                self.getProductGroup = function(){
                    if (self.searchField&&self.searchValue) $http.get("js/get-group-results.json",{params:{field:self.searchField,strict:self.strict,value:self.searchValue}}).then(function(response){
                        self.results = response.data;
                        self.originalResults = angular.copy(self.results);
                    },function(response){});
                };
                self.changeSearch = function(k,v){
                    self.searchField = k;
                    self.strict = "true";
                    self.searchValue = v;
                    self.getProductGroup();
                };
                self.batchEdit = function(k,v){
                    for (var i = 0; i<self.results.length; i++) {
                        self.results[i][k] = v;
                    };
                };
                self.save = function(){
                    var postParams = {};
                    for (var i = 0; i<self.results.length; i++) {
                        var k = self.results[i]["PR_ProductID"];
                        for (var j in self.results[i]) {
                            if (self.results[i][j]!=self.originalResults[i][j]) postParams[k+"__"+j] = self.results[i][j];
                       };
                    };
                    $http.post("php/update.php",{params:postParams}).then(function(response){
                        window.alert("!");
                    },function(response){})
                };
                self.getColumns();
            });
        </script>
    </head>
    <body ng-controller="theController as main">
        <ng-include src="'incl/navbar.html'"></ng-include>
        <ng-include src="'incl/alerts.html'"></ng-include>
        <div class="container jwl-normal-container">
            <h1>Product Group Editor</h1>
            <p><form role="form" class="form-inline">
                <div class="form-group">
                    <select class="form-control" ng-model="main.searchField">
                        <option ng-repeat="(columnName,columnMeta) in main.columns" value="{{columnName}}">{{columnName}}</option>
                    </select>                    
                </div>
                <div class="form-group">
                    <select class="form-control" ng-model="main.searchIsStrict">
                        <option value="1">equals</option>
                        <option value="0">contains</option>
                    </select>
                </div>
                <div class="form-group"><input class="form-control" type="text" ng-model="main.searchValue"></div>
                <button type="submit" ng-click="main.getProductGroup()" class="btn btn-primary"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search</button>
            </form></p>
            <p><button type="button" ng-repeat="(columnName,columnMeta) in main.columns" ng-click="columnMeta.isVisible = !columnMeta.isVisible" ng-hide="columnMeta.isVisible" class="btn btn-xs btn-success">{{columnName}}</button></p>
            <table class="table table-bordered">
                <thead><tr><th ng-repeat="(columnName,columnMeta) in mc.columns" ng-show="columnMeta.show"><button type="button" ng-click="columnMeta.show = !columnMeta.show" class="btn btn-xs btn-success">{{columnName}}</button><button type="button" ng-click="mc.options.sortOrder = columnName"  class="btn btn-xs btn-success"><span class="glyphicon glyphicon-sort-by-attributes-alt" aria-hidden="true"></span></button><button type="button" ng-click="mc.options.sortOrder = '-'+columnName" class="btn btn-xs btn-success"><span class="glyphicon glyphicon-sort-by-attributes" aria-hidden="true"></span></button></th></tr></thead>
                <tr ng-repeat="resultRow in mc.results | orderBy: mc.options.sortOrder">
                    <td ng-repeat="(resultCol,resultCell) in resultRow" ng-show="mc.columns[resultCol].show">
                        <div ng-hide="mc.columns[resultCol].readonly" ng-click="editing = true"><a>{{resultCell}}</a>&nbsp;</div>
                        <div ng-hide="!mc.columns[resultCol].readonly">{{resultCell}}</div>
                        <div style="position:absolute" ng-show="editing"><form role="form" class="form-inline">
                                <div class="form-group"><input class="form-control" type="text" ng-model="resultCell"></div>
                                <button type="button" ng-click="mc.changeSearch(resultCol,resultCell)" class="btn btn-default"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>     
                                <button type="button" ng-click="mc.batchEdit(resultCol,resultCell)" class="btn btn-default"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></button>
                                <button type="submit" class="btn btn-primary" ng-click="editing = false"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></button>
                        </form></div>
                    </td>
                </tr>
            </table>
            <p><button type="submit" ng-click="mc.save()" class="btn btn-primary">Save</button></p>
        </div>
        <ng-include src="'incl/footer.html'"></ng-include>
    </body>
</html>